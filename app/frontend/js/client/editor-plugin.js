(()=>{"use strict";var e,t,n,o,r,i,s;(s=e||(e={})).Call="call",s.Reply="reply",s.Syn="syn",s.SynAck="synAck",s.Ack="ack",function(e){e.Fulfilled="fulfilled",e.Rejected="rejected"}(t||(t={})),(i=n||(n={})).ConnectionDestroyed="ConnectionDestroyed",i.ConnectionTimeout="ConnectionTimeout",i.NoIframeSrc="NoIframeSrc",function(e){e.DataCloneError="DataCloneError"}(o||(o={})),(r||(r={})).Message="message";const c=({name:e,message:t,stack:n})=>({name:e,message:t,stack:n});let a=0;const d=()=>++a,l=e=>e?e.split("."):[],u=(e,t,n)=>{const o=l(t);return o.reduce(((e,t,r)=>(void 0===e[t]&&(e[t]={}),r===o.length-1&&(e[t]=n),e[t])),e),e},g=(e,t)=>{const n={};return Object.keys(e).forEach((o=>{const r=e[o],i=((e,t)=>{const n=l(t||"");return n.push(e),(e=>e.join("."))(n)})(o,t);"object"==typeof r&&Object.assign(n,g(r,i)),"function"==typeof r&&(n[i]=r)})),n},m=(o,i,s,c,a)=>{const{localName:l,local:g,remote:m,originForSending:p,originForReceiving:h}=i;let v=!1;a(`${l}: Connecting call sender`);const y=s.reduce(((o,i)=>{return o[i]=(s=i,(...o)=>{let i;a(`${l}: Sending ${s}() call`);try{m.closed&&(i=!0)}catch(e){i=!0}if(i&&c(),v){const e=new Error(`Unable to send ${s}() call due to destroyed connection`);throw e.code=n.ConnectionDestroyed,e}return new Promise(((n,i)=>{const c=d(),u=o=>{if(o.source!==m||o.data.penpal!==e.Reply||o.data.id!==c)return;if("*"!==h&&o.origin!==h)return void a(`${l} received message from origin ${o.origin} which did not match expected origin ${h}`);const d=o.data;a(`${l}: Received ${s}() reply`),g.removeEventListener(r.Message,u);let p=d.returnValue;d.returnValueIsError&&(p=(e=>{const t=new Error;return Object.keys(e).forEach((n=>t[n]=e[n])),t})(p)),(d.resolution===t.Fulfilled?n:i)(p)};g.addEventListener(r.Message,u);const v={penpal:e.Call,id:c,methodName:s,args:o};m.postMessage(v,p)}))}),o;var s}),{});return Object.assign(o,(e=>{const t={};for(const n in e)u(t,n,e[n]);return t})(y)),()=>{v=!0}},p=(i={})=>{const{parentOrigin:s="*",methods:a={},timeout:d,debug:l=!1}=i,u=(e=>(...t)=>{e&&console.log("[Penpal]",...t)})(l),p=((e,t)=>{const n=[];let o=!1;return{destroy(e){o||(o=!0,t("Child: Destroying connection"),n.forEach((t=>{t(e)})))},onDestroy(e){o?e():n.push(e)}}})(0,u),{destroy:h,onDestroy:v}=p,y=g(a),f=((n,i,s,a)=>{const{destroy:d,onDestroy:l}=s;return s=>{if(!(n instanceof RegExp?n.test(s.origin):"*"===n||n===s.origin))return void a(`Child: Handshake - Received SYN-ACK from origin ${s.origin} which did not match expected origin ${n}`);a("Child: Handshake - Received SYN-ACK, responding with ACK");const u="null"===s.origin?"*":s.origin,g={penpal:e.Ack,methodNames:Object.keys(i)};window.parent.postMessage(g,u);const p={localName:"Child",local:window,remote:window.parent,originForSending:u,originForReceiving:s.origin},h=((n,i,s)=>{const{localName:a,local:d,remote:l,originForSending:u,originForReceiving:g}=n;let m=!1;const p=n=>{if(n.source!==l||n.data.penpal!==e.Call)return;if("*"!==g&&n.origin!==g)return void s(`${a} received message from origin ${n.origin} which did not match expected origin ${g}`);const r=n.data,{methodName:d,args:p,id:h}=r;s(`${a}: Received ${d}() call`);const v=n=>r=>{if(s(`${a}: Sending ${d}() reply`),m)return void s(`${a}: Unable to send ${d}() reply due to destroyed connection`);const i={penpal:e.Reply,id:h,resolution:n,returnValue:r};n===t.Rejected&&r instanceof Error&&(i.returnValue=c(r),i.returnValueIsError=!0);try{l.postMessage(i,u)}catch(n){if(n.name===o.DataCloneError){const o={penpal:e.Reply,id:h,resolution:t.Rejected,returnValue:c(n),returnValueIsError:!0};l.postMessage(o,u)}throw n}};new Promise((e=>e(i[d].apply(i,p)))).then(v(t.Fulfilled),v(t.Rejected))};return d.addEventListener(r.Message,p),()=>{m=!0,d.removeEventListener(r.Message,p)}})(p,i,a);l(h);const v={},y=m(v,p,s.data.methodNames,d,a);return l(y),v}})(s,y,p,u),w=new Promise(((t,o)=>{const i=((e,t)=>{let o;return void 0!==e&&(o=window.setTimeout((()=>{const o=new Error(`Connection timed out after ${e}ms`);o.code=n.ConnectionTimeout,t(o)}),e)),()=>{clearTimeout(o)}})(d,h),c=n=>{if((()=>{try{clearTimeout()}catch(e){return!1}return!0})()&&n.source===parent&&n.data&&n.data.penpal===e.SynAck){const e=f(n);e&&(window.removeEventListener(r.Message,c),i(),t(e))}};window.addEventListener(r.Message,c),(()=>{u("Child: Handshake - Sending SYN");const t={penpal:e.Syn},n=s instanceof RegExp?"*":s;window.parent.postMessage(t,n)})(),v((e=>{window.removeEventListener(r.Message,c),e&&o(e)}))}));return{promise:w,destroy(){h()}}};class h{constructor(){this.events=new Map,this.register=e=>!(!(e=>["molchange","selectionchange","undo","redo"].includes(e))(e)||this.hasEvent(e)||(this.events.set(e),0)),this.hasEvent=e=>this.events.has(e)}}!function(e,t){var n;function o(t){let o="*";t.hasOwnProperty("domains")&&"string"==typeof t.domains&&(o=t.domains),p({methods:{getDisplaySettings:()=>new Promise((e=>{e(n.getDisplaySettings())})),exportStructure:(e,t)=>new Promise(((o,r)=>{const i=t||{};n.exportStructure(e,i).then(o,r)})),importStructure:(e,t,o)=>new Promise(((r,i)=>{const s=o||{};n.importStructure(e,t,s).then(r,i)})),pasteStructure:(e,t,o)=>new Promise(((r,i)=>{const s=o||{};n.pasteStructure(e,t,s).then(r,i)})),setDisplaySettings:e=>(n.setDisplaySettings(e),Promise.resolve()),isEmpty(){const e=n.isEmpty();return Promise.resolve(e)},clear:()=>(n.clear(),Promise.resolve()),on(e){r.register(e)&&n.on(e,(()=>{i(e)}))}},debug:!1,timeout:1e4,parentOrigin:o}).promise.then((async t=>{e.onReady((function(){s.createEditor(),i=e=>{t.fire(e)},t.onSketchLoaded()}))}))}var r=new h,i=e=>{},s={createEditor:function(t){var o=t||{};void 0!==o.license&&e.Sketch.license(o.license),n=new e.Sketch("sketch"),void 0!==o.settings&&n.setDisplaySettings(o.settings),void 0!==o.webservices?n.setServices(o.webservices):"function"==typeof getDefaultServices&&n.setServices(getDefaultServices.apply())}};"complete"===document.readyState||"interactive"===document.readyState?o(t):document.addEventListener("DOMContentLoaded",(()=>{o(t)}))}(marvin,window)})();
//# sourceMappingURL=editor-plugin.js.map